<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <title>Elite Performance Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --accent-blue: #0066FF;
            --soft-grey: #F5F5F7;
            --border-grey: #E5E5EA;
            --text-main: #1D1D1F;
            --cut-red: #FF3B30;
            --bulk-green: #34C759;
        }

        body { 
            background: #FFFFFF; 
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 110px; 
            -webkit-user-select: none; 
            user-select: none;
            touch-action: manipulation;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card { 
            border-radius: 12px; 
            border: 1px solid var(--border-grey); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); 
            margin-bottom: 15px; 
            padding: 20px; 
            background: #FFFFFF;
            animation: slideIn 0.4s ease-out;
        }

        .table > :not(caption) > * > * {
            background-color: transparent !important;
            --bs-table-accent-bg: transparent !important;
            box-shadow: none !important;
        }

        .table-header-custom {
            background-color: #F5F5F7 !important;
        }
        
        .table-header-custom th {
            color: #000000 !important;
            font-weight: 800 !important;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-grey) !important;
            padding: 10px 5px !important;
        }

        .nav-bottom { 
            position: fixed; 
            bottom: 0; 
            left:0; 
            width: 100%; 
            background: rgba(255,255,255,0.9); 
            backdrop-filter: blur(20px); 
            display: flex; 
            justify-content: space-around; 
            padding: 12px 0 35px; 
            border-top: 1px solid var(--border-grey); 
            z-index: 1000; 
        }

        .nav-item { 
            color: #86868B; 
            font-weight: 600; 
            font-size: 10px; 
            cursor: pointer; 
            text-align: center; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .nav-item.active { 
            color: var(--text-main); 
        }

        .form-control { 
            background: var(--soft-grey); 
            border: 1px solid transparent; 
            border-radius: 10px; 
            padding: 12px; 
            font-size: 16px; 
            margin-bottom: 10px; 
            transition: all 0.2s;
        }

        .form-control:focus { 
            background: #FFFFFF;
            border-color: var(--text-main);
            box-shadow: none;
        }

        .btn-primary { 
            background: var(--text-main);
            border: none; 
            border-radius: 10px; 
            padding: 14px; 
            font-weight: 600; 
            width: 100%; 
            transition: opacity 0.2s;
        }

        .target-pill { 
            background: var(--text-main); 
            color: #fff; 
            border-radius: 12px; 
            padding: 16px 10px; 
            margin-bottom: 20px; 
            cursor: pointer;
        }

        .macro-mini-label { font-size: 8px; color: #86868B; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .macro-mini-value { font-size: 15px; font-weight: 700; color: #FFFFFF; }

        .section-title { 
            font-size: 11px; 
            font-weight: 700; 
            color: #86868B; 
            text-transform: uppercase; 
            margin-bottom: 12px; 
            margin-top: 5px; 
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        
        .section-title::after {
            content: "";
            height: 1px;
            background: var(--border-grey);
            flex-grow: 1;
            margin-left: 10px;
        }

        .toggle-label { font-size: 10px; font-weight: 600; color: #1D1D1F; margin-bottom: 4px; display: block; }

        .avg-card { 
            background: var(--soft-grey); 
            border-radius: 10px; 
            padding: 12px; 
            text-align: center; 
        }

        .avg-value { font-size: 17px; font-weight: 700; color: var(--text-main); }
        .avg-label { font-size: 9px; color: #86868B; text-transform: uppercase; }

        .strategy-row {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border-grey);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .strategy-name { font-weight: 800; font-size: 12px; width: 80px; }
        .strategy-cal { font-weight: 700; color: var(--accent-blue); }
        .strategy-macros { font-size: 11px; color: #86868B; }

        .date-range-badge { 
            background: var(--soft-grey); 
            color: var(--text-main); 
            font-size: 11px; 
            padding: 10px; 
            border-radius: 10px; 
            font-weight: 700; 
            display: block; 
            margin-bottom: 20px; 
            text-align: center;
            border: 1px solid var(--border-grey);
        }

        .coach-box {
            background: #F2F2F7;
            border-left: 4px solid var(--accent-blue);
            padding: 15px;
            border-radius: 0 10px 10px 0;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .decision-highlight { 
            font-weight: 800; 
            color: var(--accent-blue); 
            display: block; 
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .goal-selector {
            background: var(--soft-grey);
            border-radius: 10px;
            padding: 4px;
            display: flex;
            margin-bottom: 20px;
        }

        .goal-option {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 10px;
            font-weight: 700;
            color: #86868B;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .goal-option.active {
            background: #FFFFFF;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SB_URL = "https://uueppqsuytroyhirrzkx.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1ZXBwcXN1eXRyb3loaXJyemt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjAyMjIsImV4cCI6MjA4NDU5NjIyMn0.mGUyMMeuF5Ce7pTnsg5INGaR4v-ZsfQNoQgjbYZ_3Gw";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        const cleanNum = (val) => val.toString().replace(/[^0-9.]/g, '');

        const getHelmsMacros = (weightKg, goal) => {
            const kcalPerKg = goal === 'bulk' ? 32 : goal === 'maintain' ? 30 : 27;
            const fatPct = goal === 'bulk' ? 0.30 : 0.25;
            const totalCalories = weightKg * kcalPerKg;
            const protein = weightKg * 2.4;
            const fat = (totalCalories * fatPct) / 9;
            const carbs = (totalCalories - (protein * 4) - (fat * 9)) / 4;
            return { 
                protein: Math.round(protein), 
                carbs: Math.round(carbs), 
                fat: Math.round(fat), 
                totalCalories: Math.round(totalCalories) 
            };
        };

        function App() {
            const [view, setView] = useState('stats');
            const [session, setSession] = useState(null);
            const [isBooting, setIsBooting] = useState(true);

            useEffect(() => {
                _supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setIsBooting(false);
                });

                const { data: { subscription } } = _supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                });

                return () => subscription.unsubscribe();
            }, []);

            const handleSignOut = async (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                try {
                    await _supabase.auth.signOut();
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.replace(window.location.origin + window.location.pathname);
                } catch (err) {
                    console.error(err);
                    window.location.reload();
                }
            };

            if (isBooting) return <div className="p-5 text-center text-muted">Syncing...</div>;
            if (!session) return <Login />;

            return (
                <div className="container py-4">
                    <div className="d-flex justify-content-between align-items-center mb-3">
                        <h5 className="fw-bold m-0" style={{letterSpacing: '-0.5px'}}>ELITE PERFORMANCE</h5>
                        <div className="badge rounded-pill text-dark border">v9.9.4</div>
                    </div>

                    {view === 'log' && <DailyLog user={session.user} />}
                    {view === 'update' && <Metrics user={session.user} />}
                    {view === 'stats' && <Stats user={session.user} />}
                    
                    <div className="nav-bottom">
                        <div className={`nav-item ${view === 'log' ? 'active' : ''}`} onClick={()=>setView('log')}>Log</div>
                        <div className={`nav-item ${view === 'update' ? 'active' : ''}`} onClick={()=>setView('update')}>Update</div>
                        <div className={`nav-item ${view === 'stats' ? 'active' : ''}`} onClick={()=>setView('stats')}>Stats</div>
                        <div className="nav-item text-danger" onClick={handleSignOut}>Exit</div>
                    </div>
                </div>
            );
        }

        function DailyLog({ user }) {
            const [f, setF] = useState({ date: new Date().toISOString().split('T')[0], weight:'', steps:'', p:'', c:'', f:'', water:'', sleep:'' });
            const [targets, setTargets] = useState(() => {
                const saved = localStorage.getItem('macro_targets');
                return saved ? JSON.parse(saved) : { p: 180, c: 200, f: 60 };
            });
            const [editTargets, setEditTargets] = useState(false);

            useEffect(() => {
                const fetchData = async () => {
                    const { data } = await _supabase.from('daily_logs').select('*').eq('user_id', user.id).eq('log_date', f.date).maybeSingle();
                    if (data) setF({ ...f, weight: data.weight||'', steps: data.steps||'', p: data.protein||'', c: data.carbs||'', f: data.fats||'', water: data.water_liters||'', sleep: data.sleep_hours||'' });
                    else setF({ ...f, weight:'', steps:'', p:'', c:'', f:'', water:'', sleep:'' });
                };
                fetchData();
            }, [f.date]);

            const saveLog = async () => {
                if (!f.weight || !f.steps) return alert("Weight and Steps are required.");
                const { error } = await _supabase.from('daily_logs').upsert({
                    user_id: user.id, log_date: f.date, weight: parseFloat(f.weight),
                    protein: parseInt(f.p)||0, carbs: parseInt(f.c)||0, fats: parseInt(f.f)||0,
                    steps: parseInt(f.steps), water_liters: parseFloat(f.water)||0, sleep_hours: parseFloat(f.sleep)||0
                }, { onConflict: 'user_id,log_date' });
                if (error) alert(error.message); else alert("Saved Successfully");
            };

            return (
                <div key="daily">
                    {!editTargets ? (
                        <div className="target-pill" onClick={() => setEditTargets(true)}>
                            <div className="macro-container d-flex justify-content-around text-center">
                                <div className="macro-box"><span className="macro-mini-label">Protein</span><br/><span className="macro-mini-value">{targets.p}g</span></div>
                                <div className="macro-box"><span className="macro-mini-label">Carbs</span><br/><span className="macro-mini-value">{targets.c}g</span></div>
                                <div className="macro-box"><span className="macro-mini-label">Fats</span><br/><span className="macro-mini-value">{targets.f}g</span></div>
                            </div>
                        </div>
                    ) : (
                        <div className="card mb-3" style={{background: '#F5F5F7'}}>
                            <div className="row g-2">
                                <div className="col-4"><label className="macro-mini-label">P (g)</label><input className="form-control" type="number" inputMode="numeric" value={targets.p} onChange={e=>setTargets({...targets, p: cleanNum(e.target.value)})} /></div>
                                <div className="col-4"><label className="macro-mini-label">C (g)</label><input className="form-control" type="number" inputMode="numeric" value={targets.c} onChange={e=>setTargets({...targets, c: cleanNum(e.target.value)})} /></div>
                                <div className="col-4"><label className="macro-mini-label">F (g)</label><input className="form-control" type="number" inputMode="numeric" value={targets.f} onChange={e=>setTargets({...targets, f: cleanNum(e.target.value)})} /></div>
                            </div>
                            <button className="btn btn-dark btn-sm w-100 mt-2" onClick={() => { localStorage.setItem('macro_targets', JSON.stringify(targets)); setEditTargets(false); }}>Save Targets</button>
                        </div>
                    )}
                    <div className="card">
                        <input type="date" className="form-control mb-3 fw-bold" value={f.date} onChange={e=>setF({...f, date:e.target.value})} />
                        <div className="section-title">Core Metrics</div>
                        <div className="row g-2">
                            <div className="col-6"><label className="toggle-label">Weight (kg) *</label><input type="number" step="any" inputMode="decimal" className="form-control" value={f.weight} onChange={e=>setF({...f, weight: cleanNum(e.target.value)})} /></div>
                            <div className="col-6"><label className="toggle-label">Steps *</label><input type="number" inputMode="numeric" className="form-control" value={f.steps} onChange={e=>setF({...f, steps: cleanNum(e.target.value)})} /></div>
                        </div>
                        <div className="section-title mt-2">Nutrient Intake</div>
                        <div className="row g-2">
                            <div className="col-4"><label className="toggle-label">P</label><input type="number" inputMode="numeric" className="form-control" value={f.p} onChange={e=>setF({...f, p: cleanNum(e.target.value)})} /></div>
                            <div className="col-4"><label className="toggle-label">C</label><input type="number" inputMode="numeric" className="form-control" value={f.p} onChange={e=>setF({...f, c: cleanNum(e.target.value)})} /></div>
                            <div className="col-4"><label className="toggle-label">F</label><input type="number" inputMode="numeric" className="form-control" value={f.f} onChange={e=>setF({...f, f: cleanNum(e.target.value)})} /></div>
                        </div>
                        <div className="section-title mt-2">Recovery</div>
                        <div className="row g-2">
                            <div className="col-6"><label className="toggle-label">Water (L)</label><input type="number" step="any" inputMode="decimal" className="form-control" value={f.water} onChange={e=>setF({...f, water: cleanNum(e.target.value)})} /></div>
                            <div className="col-6"><label className="toggle-label">Sleep (H)</label><input type="number" step="any" inputMode="decimal" className="form-control" value={f.sleep} onChange={e=>setF({...f, sleep: cleanNum(e.target.value)})} /></div>
                        </div>
                        <button className="btn btn-primary mt-3" onClick={saveLog}>Save Daily Record</button>
                    </div>
                </div>
            );
        }

        function Metrics({ user }) {
            const [f, setF] = useState({ chest:'', waist:'', glute:'', larm:'', rarm:'', lthigh:'', rthigh:'' });
            const [startDate, setStartDate] = useState(localStorage.getItem('coach_start_date') || '2026-01-21');
            
            const getWeekInfo = () => {
                const start = new Date(startDate);
                const today = new Date();
                const diffTime = Math.abs(today - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const weekNum = Math.ceil(diffDays / 7) || 1;
                const weekStart = new Date(start);
                weekStart.setDate(start.getDate() + (weekNum - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);
                return { num: weekNum, range: `${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}` };
            };

            const weekInfo = getWeekInfo();

            const submitCheckin = async () => {
                if (!f.waist || !f.chest) return alert("Waist and Chest are mandatory.");
                const { error } = await _supabase.from('weekly_metrics').upsert({
                    user_id: user.id, 
                    week_number: weekInfo.num,
                    chest: parseFloat(f.chest), 
                    waist: parseFloat(f.waist), 
                    glute: parseFloat(f.glute)||0,
                    left_arm: parseFloat(f.larm)||0, 
                    right_arm: parseFloat(f.rarm)||0,
                    left_thigh: parseFloat(f.lthigh)||0, 
                    right_thigh: parseFloat(f.rthigh)||0
                }, { onConflict: 'user_id,week_number' });
                if (error) alert(error.message); else alert(`Week ${weekInfo.num} Updated`);
            };

            return (
                <div className="card">
                    <label className="toggle-label">Program Start Date</label>
                    <input type="date" className="form-control mb-3" value={startDate} onChange={e=>{setStartDate(e.target.value); localStorage.setItem('coach_start_date', e.target.value);}} />
                    <div className="date-range-badge">WEEK {weekInfo.num}<br/><span style={{fontSize:'10px', opacity:0.6}}>{weekInfo.range}</span></div>
                    <div className="section-title">Measurements</div>
                    <div className="row g-2 mb-2">
                        <div className="col-6"><label className="toggle-label">Waist *</label><input type="number" step="any" inputMode="decimal" className="form-control" value={f.waist} onChange={e=>setF({...f, waist: cleanNum(e.target.value)})} /></div>
                        <div className="col-6"><label className="toggle-label">Chest *</label><input type="number" step="any" inputMode="decimal" className="form-control" value={f.chest} onChange={e=>setF({...f, chest: cleanNum(e.target.value)})} /></div>
                    </div>
                    <div className="row g-2 mb-2">
                        <div className="col-6"><label className="toggle-label">Left Arm</label><input type="number" step="any" inputMode="decimal" className="form-control" value={f.larm} onChange={e=>setF({...f, larm: cleanNum(e.target.value)})} /></div>
                        <div className="col-6"><label className="toggle-label">Right Arm</label><input type="number" step="any" inputMode="decimal" className="form-control" value={f.rarm} onChange={e=>setF({...f, rarm: cleanNum(e.target.value)})} /></div>
                    </div>
                    <div className="row g-2 mb-3">
                        <div className="col-12"><label className="toggle-label">Glutes</label><input type="number" step="any" inputMode="decimal" className="form-control" value={f.glute} onChange={e=>setF({...f, glute: cleanNum(e.target.value)})} /></div>
                    </div>
                    <div className="row g-2 mb-3">
                        <div className="col-6"><label className="toggle-label">Left Thigh</label><input type="number" step="any" inputMode="decimal" className="form-control" value={f.lthigh} onChange={e=>setF({...f, lthigh: cleanNum(e.target.value)})} /></div>
                        <div className="col-6"><label className="toggle-label">Right Thigh</label><input type="number" step="any" inputMode="decimal" className="form-control" value={f.rthigh} onChange={e=>setF({...f, rthigh: cleanNum(e.target.value)})} /></div>
                    </div>
                    <button className="btn btn-primary mt-2" onClick={submitCheckin}>Submit Weekly Stats</button>
                </div>
            );
        }

        function Stats({ user }) {
            const [logs, setLogs] = useState([]);
            const [metrics, setMetrics] = useState([]);
            const [dateFrom, setDateFrom] = useState(new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
            const [dateTo, setDateTo] = useState(new Date().toISOString().split('T')[0]);
            const [goal, setGoal] = useState(() => localStorage.getItem('coach_goal') || 'cut');
            const canvasRef = useRef(null);
            const chartInstance = useRef(null);

            const loadData = async () => {
                const { data: logData } = await _supabase.from('daily_logs').select('*').eq('user_id', user.id).gte('log_date', dateFrom).lte('log_date', dateTo).order('log_date', {ascending: false});
                const { data: metricData } = await _supabase.from('weekly_metrics').select('*').eq('user_id', user.id).order('week_number', {ascending: false});
                setLogs(logData || []);
                setMetrics(metricData || []);
            };

            useEffect(() => { loadData(); }, [dateFrom, dateTo]);

            useEffect(() => {
                localStorage.setItem('coach_goal', goal);
            }, [goal]);

            useEffect(() => {
                if (canvasRef.current && logs.length > 0) {
                    const sorted = [...logs].sort((a,b) => new Date(a.log_date) - new Date(b.log_date));
                    if (chartInstance.current) chartInstance.current.destroy();
                    chartInstance.current = new Chart(canvasRef.current, {
                        type: 'line',
                        data: { 
                            labels: sorted.map(l => l.log_date.split('-').slice(1).reverse().join('/')), 
                            datasets: [{ label: 'Weight', data: sorted.map(l => l.weight), borderColor: '#0066FF', tension: 0.3, backgroundColor: 'rgba(0,102,255,0.05)', fill: true, borderWidth: 2, pointRadius: 3 }] 
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { position: 'left', grid: { color: '#F2F2F7' } } } }
                    });
                }
            }, [logs]);

            const getCoachRecommendation = () => {
                if (logs.length < 7) return "Log 7 days of data for high-confidence analysis.";
                
                const sorted = [...logs].sort((a,b) => new Date(b.log_date) - new Date(a.log_date));
                const week1 = sorted.slice(0, 7);
                const week1Avg = week1.reduce((a,b)=>a+b.weight, 0) / 7;

                const helms = getHelmsMacros(week1Avg, goal);
                
                // Added step threshold logic as requested
                const helmsDisplay = (
                    <div className="mt-2 pt-2 border-top">
                        <div style={{fontSize: '11px', opacity: 0.9, marginBottom: '8px'}}>
                            <b>Helms Strategy ({goal}):</b> {helms.totalCalories} kcal | {helms.protein}P | {helms.carbs}C | {helms.fat}F
                        </div>
                        <div style={{fontSize: '10px', opacity: 0.7, fontStyle: 'italic', lineHeight: '1.3'}}>
                            You set a minimum step threshold of 7,000 steps. Any steps up to this threshold are considered “bonus activity” that allows you to add calories to your daily intake while staying in a deficit. Steps above 7,000 are treated as extra burned calories and do not increase your intake—they just increase your total energy expenditure. The system calculates the added calories proportionally to your body weight.
                        </div>
                    </div>
                );
                
                if (logs.length < 14) {
                    return (
                        <div>
                            Baseline Set: 7-day average is {week1Avg.toFixed(2)}kg. Continue logging for 7 more days to confirm your 14-day trend.
                            {helmsDisplay}
                        </div>
                    );
                }

                const week2 = sorted.slice(7, 14);
                const week2Avg = week2.reduce((a,b)=>a+b.weight, 0) / 7;
                const delta = week1Avg - week2Avg;

                const avgCals = week1.reduce((a,b)=>a+(b.protein*4+b.carbs*4+b.fats*9),0) / 7;
                const avgSteps = week1.reduce((a,b)=>a+(b.steps||0),0) / 7;

                let feedback;
                if (goal === 'cut') {
                    if (avgCals < 2100 && avgSteps > 9500 && delta >= 0) {
                        feedback = <span><b className="decision-highlight">HOLD POSITION</b> Potential "Whoosh" detected. Activity is high and calories are controlled, but water is masking fat loss. Do not adjust yet.</span>;
                    } else if (Math.abs(delta) < 0.1) {
                        feedback = <span><b className="decision-highlight">ACTION: PLATEAU CONFIRMED</b> Weight is flat. Apply a 150kcal shift below to resume progress.</span>;
                    } else if (delta <= -0.4) {
                        feedback = <span><b className="decision-highlight">SUSTAIN: ON TRACK</b> You are losing ~{Math.abs(delta).toFixed(2)}kg per week. This is optimal for muscle retention. Stay the course.</span>;
                    }
                } else if (goal === 'bulk') {
                    if (delta >= 0.1 && delta <= 0.3) {
                        feedback = <span><b className="decision-highlight">PERFECT GAIN RATE</b> You are gaining ~{delta.toFixed(2)}kg per week. Muscle growth is prioritized with minimal fat.</span>;
                    } else if (delta < 0.1) {
                        feedback = <span><b className="decision-highlight">ACTION: INCREASE CALORIES</b> Growth is stalled. Shift +150kcal to enter a surplus.</span>;
                    } else if (delta > 0.4) {
                        feedback = <span><b className="decision-highlight">ACTION: SCALE BACK</b> Gaining too fast. Reduce surplus to avoid unnecessary fat accumulation.</span>;
                    }
                } else if (goal === 'maintain') {
                    if (Math.abs(delta) <= 0.2) {
                        feedback = <span><b className="decision-highlight">STABLE</b> Maintenance successful. Metabolic rate is balanced with intake.</span>;
                    } else {
                        feedback = <span><b className="decision-highlight">ADJUSTMENT NEEDED</b> Weight is drifting. Re-sync to maintenance pathway.</span>;
                    }
                }

                return (
                    <div>
                        {feedback || `14-Day Trend: ${delta > 0 ? '+' : ''}${delta.toFixed(2)}kg. Metabolic rate is adapting. Precision phase active.`}
                        {helmsDisplay}
                    </div>
                );
            };

            const getMacroPathways = () => {
                if (logs.length < 7) return null;
                const sorted = [...logs].sort((a,b) => new Date(a.log_date) - new Date(a.log_date));
                const week = sorted.slice(0, 7);
                const avgW = week.reduce((a,b)=>a+b.weight,0) / 7;
                const avgK = week.reduce((a,b)=>a+(b.protein*4+b.carbs*4+b.fats*9),0) / 7;
                const avgS = week.reduce((a,b)=>a+(b.steps||0),0) / 7;
                const tdee = avgK + ((avgS - 8000) * 0.04);
                
                const calc = (c) => ({ cal: Math.round(c), p: Math.round(avgW*2), f: Math.round((c*0.29)/9), c: Math.round((c-(avgW*2*4)-((c*0.29)/9*9))/4) });
                return { bulk: calc(tdee+150), maint: calc(tdee), cut: calc(tdee-150), tdeeVal: Math.round(tdee), currentWeight: avgW };
            };

            const paths = getMacroPathways();
            const recommendation = getCoachRecommendation();

            const calculateAverages = () => {
                if (logs.length === 0) return { loss: 0, kcal: 0, steps: 0, color: '#1D1D1F', sign: '' };
                const sorted = [...logs].sort((a,b) => new Date(a.log_date) - new Date(b.log_date));
                const weightDiff = (sorted[sorted.length - 1].weight - sorted[0].weight).toFixed(1);
                const totalKcal = logs.reduce((acc, l) => acc + (l.protein*4 + l.carbs*4 + l.fats*9), 0);
                const totalSteps = logs.reduce((acc, l) => acc + (l.steps || 0), 0);
                return { loss: Math.abs(weightDiff), kcal: Math.round(totalKcal / logs.length), steps: Math.round(totalSteps / logs.length), color: weightDiff > 0 ? '#34C759' : weightDiff < 0 ? '#FF3B30' : '#1D1D1F', sign: weightDiff > 0 ? '+' : weightDiff < 0 ? '-' : '' };
            };

            const getProjections = () => {
                if (logs.length < 14 || !paths) return { goal: 'Calculating...', tdee: paths ? paths.tdeeVal : '...' };
                const sorted = [...logs].sort((a,b) => new Date(b.log_date) - new Date(a.log_date));
                const week1Avg = sorted.slice(0, 7).reduce((a,b)=>a+b.weight, 0) / 7;
                const week2Avg = sorted.slice(7, 14).reduce((a,b)=>a+b.weight, 0) / 7;
                const delta = week1Avg - week2Avg;
                const projection = week1Avg + (delta * 4);
                return { goal: `${projection.toFixed(1)}kg`, tdee: paths.tdeeVal };
            };

            const stats = calculateAverages();
            const projections = getProjections();

            return (
                <div>
                    <div className="section-title">Current Objective</div>
                    <div className="goal-selector">
                        <div className={`goal-option ${goal === 'cut' ? 'active' : ''}`} onClick={() => setGoal('cut')}>Cut</div>
                        <div className={`goal-option ${goal === 'maintain' ? 'active' : ''}`} onClick={() => setGoal('maintain')}>Maintain</div>
                        <div className={`goal-option ${goal === 'bulk' ? 'active' : ''}`} onClick={() => setGoal('bulk')}>Bulk</div>
                    </div>

                    <div className="section-title">Coach Recommendation</div>
                    <div className="coach-box">{recommendation}</div>

                    <div className="card">
                        <div className="section-title">Weight Trend</div>
                        <div className="row g-2 mb-3">
                            <div className="col-6"><label className="toggle-label">From</label><input type="date" className="form-control" value={dateFrom} onChange={e=>setDateFrom(e.target.value)} /></div>
                            <div className="col-6"><label className="toggle-label">To</label><input type="date" className="form-control" value={dateTo} onChange={e=>setDateTo(e.target.value)} /></div>
                        </div>
                        <div style={{height: '180px'}}><canvas ref={canvasRef}></canvas></div>
                    </div>

                    <div className="section-title">Period Averages</div>
                    <div className="row g-2 mb-3">
                        <div className="col-4"><div className="avg-card"><div className="avg-label">Trend</div><div className="avg-value" style={{ color: stats.color }}>{stats.sign}{stats.loss}kg</div></div></div>
                        <div className="col-4"><div className="avg-card"><div className="avg-label">Kcal</div><div className="avg-value">{stats.kcal}</div></div></div>
                        <div className="col-4"><div className="avg-card"><div className="avg-label">Steps</div><div className="avg-value">{stats.steps}</div></div></div>
                    </div>

                    <div className="section-title">Projections & Insights</div>
                    <div className="row g-2 mb-3">
                        <div className="col-6"><div className="avg-card"><div className="avg-label">4-Week Goal</div><div className="avg-value">{projections.goal}</div></div></div>
                        <div className="col-6"><div className="avg-card"><div className="avg-label">Est. TDEE</div><div className="avg-value" style={{color: 'var(--accent-blue)'}}>{projections.tdee}</div></div></div>
                    </div>

                    <div className="section-title">Measurement History</div>
                    <div className="card mb-4">
                        <div className="table-responsive">
                            <table className="table table-sm m-0" style={{fontSize: '11px'}}>
                                <thead className="table-header-custom">
                                    <tr><th>WK</th><th>Waist</th><th>Chest</th><th>Arms</th><th>Thighs</th></tr>
                                </thead>
                                <tbody>
                                    {metrics.map((m, i) => (
                                        <tr key={i}>
                                            <td className="fw-bold">{m.week_number}</td>
                                            <td>{m.waist}</td>
                                            <td>{m.chest}</td>
                                            <td>{m.left_arm}/{m.right_arm}</td>
                                            <td>{m.left_thigh}/{m.right_thigh}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="section-title">Daily History</div>
                    <div className="card p-0 overflow-hidden mb-5">
                        <div className="table-responsive">
                            <table className="table table-sm m-0" style={{fontSize: '11px'}}>
                                <thead className="table-header-custom">
                                    <tr><th>Date</th><th>KG</th><th>Cal</th><th>P/C/F</th><th>Steps</th></tr>
                                </thead>
                                <tbody>
                                    {logs.map((l, i) => (
                                        <tr key={i}>
                                            <td className="fw-bold">{l.log_date.split('-').slice(1).join('/')}</td>
                                            <td>{l.weight}</td>
                                            <td className="text-primary fw-bold">{(l.protein*4 + l.carbs*4 + l.fats*9) || 0}</td>
                                            <td>{l.protein}/{l.carbs}/{l.fats}</td>
                                            <td>{l.steps?.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        function Login() {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            return (
                <div className="container vh-100 d-flex align-items-center">
                    <div className="card w-100 text-center py-5">
                        <h2 className="fw-bold mb-4" style={{letterSpacing: '-1px'}}>ELITE PERFORMANCE</h2>
                        <input className="form-control" placeholder="Email Address" onChange={e=>setEmail(e.target.value)} />
                        <input className="form-control" type="password" placeholder="Password" onChange={e=>setPass(e.target.value)} />
                        <button className="btn btn-primary mt-3" onClick={async () => {
                            const { error } = await _supabase.auth.signInWithPassword({ email, password: pass });
                            if (error) alert(error.message);
                        }}>Sign In</button>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
